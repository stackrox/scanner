// +build db_integration

package pgsql

import (
	"testing"

	"github.com/stackrox/scanner/database"
	"github.com/stackrox/scanner/pkg/component"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestLayerLanguageComponents(t *testing.T) {
	datastore, err := openDatabaseForTest("GetLayerLanguageComponents", false)
	if err != nil {
		t.Error(err)
		return
	}
	defer datastore.Close()

	// Insert layers.
	layer := database.Layer{
		Name: "TestGetLayerLanguageComponent1",
	}
	require.NoError(t, datastore.InsertLayer(layer))
	parent, err := datastore.FindLayer(layer.Name, true, false)
	require.NoError(t, err)
	layer = database.Layer{
		Name:   "TestGetLayerLanguageComponent2",
		Parent: &parent,
	}
	require.NoError(t, datastore.InsertLayer(layer))

	// InsertLayerComponents.
	parentComponents := []*component.Component{
		{
			SourceType: component.JavaSourceType,
			Name: "Java Component",
			Version: "1",
			Location: "jars/my-java-jar.jar",
			JavaPkgMetadata: &component.JavaPkgMetadata{},
		},
	}
	assert.NoError(t, datastore.InsertLayerComponents("TestGetLayerLanguageComponent1", parentComponents, nil))

	components := []*component.Component{
		{
			SourceType: component.DotNetCoreRuntimeSourceType,
			Name: ".NET Component",
			Version: "3.1.2",
			Location: "usr/share/dotnet/shared/Microsoft.NETCore.App/3.1.2/",
		},
	}
	assert.NoError(t, datastore.InsertLayerComponents("TestGetLayerLanguageComponent2", components, []string{"jars/my-java-jar.jar"}))

	// GetLayerLanguageComponents.
	layers, err := datastore.GetLayerLanguageComponents("TestGetLayerLanguageComponent1")
	require.NoError(t, err)
	assert.Equal(t, 1, len(layers))
	assert.Equal(t, "TestGetLayerLanguageComponent1", layers[0].Layer)
	assert.Equal(t, parentComponents, layers[0].Components)
	assert.Empty(t, layers[0].Removed)


	layers, err = datastore.GetLayerLanguageComponents("TestGetLayerLanguageComponent2")
	require.NoError(t, err)
	assert.Equal(t, 2, len(layers))
	assert.Equal(t, "TestGetLayerLanguageComponent1", layers[0].Layer)
	assert.Equal(t, parentComponents, layers[0].Components)
	assert.Empty(t, layers[0].Removed)
	assert.Equal(t, "TestGetLayerLanguageComponent2", layers[1].Layer)
	assert.Equal(t, components, layers[1].Components)
	assert.Equal(t, []string{"jars/my-java-jar.jar"}, layers[1].Removed)
}
