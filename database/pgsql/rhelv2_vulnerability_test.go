// +build db_integration

package pgsql

import (
	"testing"

	archop "github.com/quay/claircore"
	"github.com/stackrox/scanner/database"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestRHELv2Vulnerability(t *testing.T) {
	datastore, err := openDatabaseForTest("InsertRHELv2Vulnerability", false)
	require.NoError(t, err)
	defer datastore.Close()

	v1 := &database.RHELv2Vulnerability{
		Name:        "CVE-2021-1234",
		Description: "my vuln",
		Link:        "https://access.redhat.com/security/cve/CVE-2021-1234",
		Severity:    "Important",
		CVSSv2:      "4.0/AV:N/AC:H/Au:N/C:P/I:P/A:N",
		CPEs: []string{
			"cpe:/o:redhat:enterprise_linux:8",
		},
		PackageInfos: []*database.RHELv2PackageInfo{
			{
				FixedInVersion: "0:1.0.8-13.el8",
				ArchOperation:  archop.OpEquals,
				Packages: []*database.RHELv2Package{
					{
						Name: "package",
						Arch: "x86_64",
					},
				},
			},
		},
	}
	v2 := &database.RHELv2Vulnerability{
		Name:        "CVE-2021-1235",
		Title:       "RHSA-2013:0565: Red Hat Enterprise MRG Grid 2.3 security update (Low)",
		Description: "my vuln2",
		Link:        "https://access.redhat.com/security/cve/CVE-2021-1235",
		Severity:    "Moderate",
		CVSSv3:      "4.6/CVSS:3.0/AV:A/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:L",
		CPEs: []string{
			"cpe:/o:redhat:enterprise_linux:8",
			"cpe:/o:redhat:enterprise_linux:7",
		},
		PackageInfos: []*database.RHELv2PackageInfo{
			{
				FixedInVersion: "0:1.0.8-13.el8",
				ArchOperation:  archop.OpEquals,
				Packages: []*database.RHELv2Package{
					{
						Name: "package",
						Arch: "x86_64",
					},
				},
			},
		},
	}

	err = datastore.InsertRHELv2Vulnerabilities([]*database.RHELv2Vulnerability{v1, v2})
	assert.NoError(t, err)

	// Re-insert vulns to ensure there is no error.
	err = datastore.InsertRHELv2Vulnerabilities([]*database.RHELv2Vulnerability{v1, v2})
	assert.NoError(t, err)

	records := []*database.RHELv2Record{
		{
			Pkg: &database.RHELv2Package{
				Name: "package",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:7",
		},
	}

	// Sanity check all fields are valid for single vuln.
	vulns, err := datastore.GetRHELv2Vulnerabilities(records)
	assert.NoError(t, err)
	assert.Len(t, vulns, 1)
	assert.Len(t, vulns[0], 1)
	vuln := vulns[0][0]
	assert.Equal(t, v2.Name, vuln.Name)
	assert.Equal(t, v2.Title, vuln.Title)
	assert.Equal(t, v2.Description, vuln.Description)
	assert.Equal(t, v2.Link, vuln.Link)
	assert.Equal(t, v2.Severity, vuln.Severity)
	assert.Equal(t, v2.CVSSv3, vuln.CVSSv3)
	assert.Equal(t, v2.CVSSv2, vuln.CVSSv2)
	assert.Equal(t, v2.PackageInfos[0].Packages[0].Name, vuln.PackageInfos[0].Packages[0].Name)
	assert.Equal(t, v2.PackageInfos[0].Packages[0].Arch, vuln.PackageInfos[0].Packages[0].Arch)
	assert.Equal(t, v2.PackageInfos[0].ArchOperation, vuln.PackageInfos[0].ArchOperation)
	assert.Equal(t, v2.PackageInfos[0].FixedInVersion, vuln.PackageInfos[0].FixedInVersion)

	records = []*database.RHELv2Record{
		{
			Pkg: &database.RHELv2Package{
				Model: database.Model{ID: 0},
				Name:  "package",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:8",
		},
	}

	// Ensure both vulns are returned.
	vulns, err = datastore.GetRHELv2Vulnerabilities(records)
	assert.NoError(t, err)
	assert.Len(t, vulns, 1)
	vulnNames := make([]string, 0, len(vulns[0]))
	for _, vuln := range vulns[0] {
		vulnNames = append(vulnNames, vuln.Name)
	}
	assert.ElementsMatch(t, vulnNames, []string{v1.Name, v2.Name})

	records = []*database.RHELv2Record{
		{
			Pkg: &database.RHELv2Package{
				Model: database.Model{ID: 0},
				Name:  "package",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:7",
		},
		{
			Pkg: &database.RHELv2Package{
				Model: database.Model{ID: 0},
				Name:  "package",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:8",
		},
	}

	// Ensure only 2 vulns are returned.
	vulns, err = datastore.GetRHELv2Vulnerabilities(records)
	assert.NoError(t, err)
	assert.Len(t, vulns, 1)
	assert.Len(t, vulns[0], 2)

	v3 := &database.RHELv2Vulnerability{
		Name:        "CVE-1236",
		Description: "3",
		CPEs: []string{
			"cpe:/o:redhat:enterprise_linux:8",
			"cpe:/o:redhat:enterprise_linux:6",
		},
		PackageInfos: []*database.RHELv2PackageInfo{
			{
				Packages: []*database.RHELv2Package{
					{
						Name:    "package2",
						Version: "2",
						Arch:    "noarch",
					},
				},
			},
		},
	}

	err = datastore.InsertRHELv2Vulnerabilities([]*database.RHELv2Vulnerability{v3})
	assert.NoError(t, err)

	records = []*database.RHELv2Record{
		{
			Pkg: &database.RHELv2Package{
				Model: database.Model{ID: 0},
				Name:  "package",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:8",
		},
		{
			Pkg: &database.RHELv2Package{
				Model: database.Model{ID: 1},
				Name:  "package2",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:6",
		},
	}

	// Ensure 3 vulns are returned for package and 1 for package2.
	vulns, err = datastore.GetRHELv2Vulnerabilities(records)
	assert.NoError(t, err)
	assert.Len(t, vulns, 2)
	assert.Len(t, vulns[0], 2)
	assert.Len(t, vulns[1], 1)
}

func TestRHELv2VulnerabilityCVERemoval(t *testing.T) {
	datastore, err := openDatabaseForTest("TestRHELv2VulnerabilityCVERemoval", false)
	if err != nil {
		t.Error(err)
		return
	}
	defer datastore.Close()

	v1 := &database.RHELv2Vulnerability{
		Name:        "CVE-2021-1234",
		Description: "my vuln",
		Link:        "https://access.redhat.com/security/cve/CVE-2021-1234",
		Severity:    "Important",
		CVSSv2:      "4.0/AV:N/AC:H/Au:N/C:P/I:P/A:N",
		CPEs: []string{
			"cpe:/o:redhat:enterprise_linux:8",
		},
		PackageInfos: []*database.RHELv2PackageInfo{
			{
				FixedInVersion: "0:1.0.8-13.el8",
				ArchOperation:  archop.OpEquals,
				Packages: []*database.RHELv2Package{
					{
						Name: "package",
						Arch: "x86_64",
					},
				},
			},
		},
	}
	v2 := &database.RHELv2Vulnerability{
		Name:        "CVE-2021-1235",
		Title:       "RHSA-2013:0565: Red Hat Enterprise MRG Grid 2.3 security update (Low)",
		Description: "my vuln2",
		Link:        "https://access.redhat.com/security/cve/CVE-2021-1235",
		Severity:    "Moderate",
		CVSSv3:      "4.6/CVSS:3.0/AV:A/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:L",
		CPEs: []string{
			"cpe:/o:redhat:enterprise_linux:8",
			"cpe:/o:redhat:enterprise_linux:7",
		},
		PackageInfos: []*database.RHELv2PackageInfo{
			{
				FixedInVersion: "0:1.0.8-13.el8",
				ArchOperation:  archop.OpEquals,
				Packages: []*database.RHELv2Package{
					{
						Name: "package",
						Arch: "x86_64",
					},
				},
			},
		},
	}

	err = datastore.InsertRHELv2Vulnerabilities([]*database.RHELv2Vulnerability{v1, v2})
	assert.NoError(t, err)

	// Insert RHSA for CPE cpe:/o:redhat:enterprise_linux:7 with a fix and sub CVE for the two above
	// Only the second one should be removed as the CPE will match
	v3 := &database.RHELv2Vulnerability{
		Name:        "RHSA-2013:0565",
		Title:       "RHSA-2013:0565: Red Hat Enterprise MRG Grid 2.3 security update (Low)",
		Description: "my vuln2",
		Link:        "https://access.redhat.com/security/cve/CVE-2021-1235",
		Severity:    "Moderate",
		CVSSv3:      "4.6/CVSS:3.0/AV:A/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:L",
		CPEs: []string{
			"cpe:/o:redhat:enterprise_linux:7",
		},
		PackageInfos: []*database.RHELv2PackageInfo{
			{
				FixedInVersion: "0:1.0.8-13.el8",
				ArchOperation:  archop.OpEquals,
				Packages: []*database.RHELv2Package{
					{
						Name: "package",
						Arch: "x86_64",
					},
				},
			},
		},
		CVEs: []string{"CVE-2021-1234", "CVE-2021-1235"},
	}

	err = datastore.InsertRHELv2Vulnerabilities([]*database.RHELv2Vulnerability{v3})
	assert.NoError(t, err)

	records := []*database.RHELv2Record{
		{
			Pkg: &database.RHELv2Package{
				Name: "package",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:7",
		},
	}

	// Sanity check all fields are valid for single vuln.
	vulns, err := datastore.GetRHELv2Vulnerabilities(records)
	assert.NoError(t, err)
	assert.Len(t, vulns, 1)
	assert.Len(t, vulns[0], 1)
	vuln := vulns[0][0]
	assert.Equal(t, v3.Name, vuln.Name)

	records = []*database.RHELv2Record{
		{
			Pkg: &database.RHELv2Package{
				Model: database.Model{ID: 0},
				Name:  "package",
			},
			CPE: "cpe:/o:redhat:enterprise_linux:8",
		},
	}

	// Ensure both vulns are returned.
	vulns, err = datastore.GetRHELv2Vulnerabilities(records)
	assert.NoError(t, err)
	assert.Len(t, vulns, 1)
	vulnNames := make([]string, 0, len(vulns[0]))
	for _, vuln := range vulns[0] {
		vulnNames = append(vulnNames, vuln.Name)
	}
	assert.ElementsMatch(t, vulnNames, []string{v1.Name, v2.Name})
}
