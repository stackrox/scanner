package pgsql

import (
	"database/sql"
	"encoding/json"
	"fmt"

	"github.com/pkg/errors"
	"github.com/stackrox/scanner/pkg/component"
)

func (pgSQL *pgSQL) InsertLayerComponents(layerName string, c []*component.Component, r []string) error {
	// todo(cgorman) evaluate if we should hash marshalled component bytes and do lookups instead

	insertedLayer, err := pgSQL.FindLayer(layerName, false, false)
	if err != nil {
		return err
	}

	data, err := json.Marshal(c)
	if err != nil {
		return err
	}

	removed, err := json.Marshal(r)
	if err != nil {
		return err
	}

	_, err = pgSQL.Exec(`INSERT INTO LanguageLayer(layer_id, layer_name, component_data, removed_components)
	VALUES ($1, $2, $3, $4) ON CONFLICT DO NOTHING;`, insertedLayer.ID, insertedLayer.Name, data, removed)
	return err
}

func parseComponentData(rows *sql.Rows) (*component.LayerToComponents, error) {
	var (
		layerName string
		data      []byte
		removed   []byte
	)
	if err := rows.Scan(&layerName, &data, &removed); err != nil {
		return nil, err
	}
	var components []*component.Component
	if err := json.Unmarshal(data, &components); err != nil {
		return nil, err
	}
	var removedComponents []string
	if err := json.Unmarshal(removed, &removedComponents); err != nil {
		return nil, err
	}
	return &component.LayerToComponents{
		Layer:      layerName,
		Components: components,
		Removed:    removedComponents,
	}, nil
}

func (pgSQL *pgSQL) GetLayerLanguageComponents(layer string) ([]*component.LayerToComponents, error) {
	rows, err := pgSQL.Query(searchLanguageComponentsInImage, layer)
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	if !rows.Next() {
		return nil, fmt.Errorf("could not find layer %q for language components", layer)
	}

	layerToComponent, err := parseComponentData(rows)
	if err != nil {
		return nil, errors.Wrapf(err, "error parsing component data for %q", layer)
	}

	layersToComponents := []*component.LayerToComponents{
		layerToComponent,
	}

	for rows.Next() {
		layerToComponent, err := parseComponentData(rows)
		if err != nil {
			return nil, errors.Wrapf(err, "error parsing component data for %q", layer)
		}
		layersToComponents = append(layersToComponents, layerToComponent)
	}
	return layersToComponents, nil
}
