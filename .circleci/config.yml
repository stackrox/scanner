version: 2

defaults: &defaults
  docker:
    - image: docker.io/stackrox/apollo-ci:0.2.3
      auth:
        username: $DOCKER_IO_PULL_USERNAME
        password: $DOCKER_IO_PULL_PASSWORD
  working_directory: /go/src/github.com/stackrox/scanner

jobs:
  style-checks:
    <<: *defaults
    steps:
      - add_ssh_keys
      - checkout

      - run:
          name: Install dependencies
          command: make deps

      - run:
          name: Run style checks
          command: make style

  build:
    <<: *defaults
    steps:
    - add_ssh_keys
    - checkout
    - setup_remote_docker

    - run:
        name: Pull definitions dump
        command: |
          status_code="$(curl -w '%{http_code}' -u "${STACKROX_IO_PUSH_USERNAME}:${STACKROX_IO_PUSH_PASSWORD}" -L https://install.stackrox.io/scanner/definitions.sql.gz --output image/dump/definitions.sql.gz)"
          [[ "${status_code}" -eq 200 ]] || { echo "Failed to pull the definitions dump. Status code ${status_code}. File contents: $(head image/dump/definitions.sql.gz)"; exit 1; }

    - run:
        name: Build images
        command: make image

    - run:
        name: Set up GCloud
        command: |
          cci-export GOOGLE_APPLICATION_CREDENTIALS /tmp/gcp.json
          echo "${GOOGLE_SA_CIRCLECI_SCANNER}" > "${GOOGLE_APPLICATION_CREDENTIALS}"
          chmod 0600 "${GOOGLE_APPLICATION_CREDENTIALS}"
          gcloud auth activate-service-account --key-file "${GOOGLE_APPLICATION_CREDENTIALS}"
          gcloud auth list
          gcloud auth configure-docker

workflows:
  version: 2

  build:
    jobs:
    - style-checks:
        context: docker-io-pull
        filters:
          tags:
            only: /.*/
    - build:
        context: docker-io-and-stackrox-io-push
        filters:
          tags:
            only: /.*/
